<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OpenAIApiService.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">app</a> &gt; <a href="index.source.html" class="el_package">com.serenityai.data.remote</a> &gt; <span class="el_source">OpenAIApiService.kt</span></div><h1>OpenAIApiService.kt</h1><pre class="source lang-java linenums">package com.serenityai.data.remote

import retrofit2.http.Body
import retrofit2.http.POST

<span class="nc" id="L6">data class OpenAIRequest(</span>
<span class="nc" id="L7">    val model: String = &quot;gpt-3.5-turbo&quot;,</span>
<span class="nc" id="L8">    val messages: List&lt;OpenAIMessage&gt;,</span>
<span class="nc" id="L9">    val max_tokens: Int = 500,</span>
<span class="nc" id="L10">    val temperature: Double = 0.7</span>
<span class="nc" id="L11">)</span>

<span class="nc" id="L13">data class OpenAIResponse(</span>
<span class="nc" id="L14">    val choices: List&lt;OpenAIChoice&gt;</span>
)

<span class="nc" id="L17">data class OpenAIChoice(</span>
<span class="nc" id="L18">    val message: OpenAIMessage</span>
)

<span class="nc" id="L21">data class OpenAIMessage(</span>
<span class="nc" id="L22">    val role: String, // &quot;user&quot;, &quot;assistant&quot;, &quot;system&quot;</span>
<span class="nc" id="L23">    val content: String</span>
)

interface OpenAIApiService {
    @POST(&quot;v1/chat/completions&quot;)
    suspend fun getResponse(
        @Body request: OpenAIRequest
    ): OpenAIResponse
    
    companion object {
        const val BASE_URL = &quot;https://api.openai.com/&quot;
    }
}

<span class="nc" id="L37">class OpenAIRepository(private val apiService: OpenAIApiService) {</span>
<span class="nc" id="L38">    suspend fun generateTherapistResponse(</span>
        userMessage: String,
<span class="nc" id="L40">        context: String = &quot;&quot;,</span>
        apiKey: String
    ): Result&lt;String&gt; {
<span class="nc" id="L43">        return try {</span>
<span class="nc" id="L44">            val systemPrompt = &quot;&quot;&quot;</span>
                You are a compassionate AI therapist. Your role is to:
                - Listen actively and empathetically
                - Provide supportive and non-judgmental responses
                - Ask thoughtful questions to help users explore their feelings
                - Offer gentle guidance and coping strategies
                - Maintain professional boundaries
                - Encourage professional help when appropriate
                
<span class="nc" id="L53">                Context: $context</span>
<span class="nc" id="L54">            &quot;&quot;&quot;.trimIndent()</span>

<span class="nc" id="L56">            val messages = listOf(</span>
<span class="nc" id="L57">                OpenAIMessage(role = &quot;system&quot;, content = systemPrompt),</span>
<span class="nc" id="L58">                OpenAIMessage(role = &quot;user&quot;, content = userMessage)</span>
            )

<span class="nc" id="L61">            val request = OpenAIRequest(</span>
<span class="nc" id="L62">                model = &quot;gpt-3.5-turbo&quot;,</span>
<span class="nc" id="L63">                messages = messages,</span>
<span class="nc" id="L64">                max_tokens = 500,</span>
<span class="nc" id="L65">                temperature = 0.7</span>
            )

<span class="nc" id="L68">            val response = apiService.getResponse(request)</span>
<span class="nc bnc" id="L69" title="All 4 branches missed.">            val aiResponse = response.choices.firstOrNull()?.message?.content</span>
<span class="nc bnc" id="L70" title="All 2 branches missed.">            if (aiResponse != null) {</span>
<span class="nc" id="L71">                Result.success(aiResponse)</span>
            } else {
<span class="nc" id="L73">                Result.failure(Exception(&quot;Empty response from AI&quot;))</span>
            }
<span class="nc" id="L75">        } catch (e: Exception) {</span>
<span class="nc" id="L76">            Result.failure(e)</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>